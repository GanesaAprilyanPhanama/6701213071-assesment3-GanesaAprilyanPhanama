<!DOCTYPE html>
<html>
<head>
  <title>Product Listing</title>
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
</head>
<body>
  <table id="productTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Price</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table><br>

  <form id="addProductForm">
    <input type="text" name="name" placeholder="Product Name"><br>
    <input type="number" name="price" step="0.01" placeholder="Product Price"><br>
    <button type="submit">Add Product</button>
  </form>


  <script>
    var table;

    $(document).ready(function() {
      table = $('#productTable').DataTable({
        ajax: '/products',
        columns: [
          { data: 'id' },
          { data: 'name' },
          { data: 'price' },
          {
            data: null,
            render: function(data, type, row) {
              return '<button onclick="editProduct(' + data.id + ')">Edit</button>' +
                '<button onclick="deleteProduct(' + data.id + ')" class="delete-btn">Delete</button>' +
                '<button onclick="updateForm(' + data.id + ')" class="update-btn">Update</button>';
            }
          }
        ]
      });

      // Add new product form submission
      $('#addProductForm').submit(function(event) {
        event.preventDefault();
        var name = $('input[name="name"]').val();
        var price = $('input[name="price"]').val();

        $.ajax({
          type: 'POST',
          url: '/products/add',
          data: { name: name, price: price },
          success: function(response) {
            alert(response.message);
            $('input[name="name"]').val('');
            $('input[name="price"]').val('');
            table.ajax.reload();
          },
          error: function(error) {
            alert('An error occurred while adding the product.');
            console.error(error);
          }
        });
      });
    });

    // Delete button event delegation
    $('#productTable tbody').on('click', '.delete-btn', function() {
      var row = $(this).closest('tr');
      var id = table.row(row).data().id;

      if (confirm('Are you sure you want to delete this product?')) {
        $.ajax({
          type: 'DELETE',
          url: '/products/delete',
          data: { id: id },
          success: function(response) {
            alert(response.message);
            table.ajax.reload();
          },
          error: function(error) {
            alert('An error occurred while deleting the product.');
            console.error(error);
          }
        });
      }
    });

    // Update button event delegation
    $('#productTable').on('click', '.update-btn', function() {
      var row = $(this).closest('tr');
      var id = table.row(row).data().id;
      var rowData = table.row(row).data();
      var formHtml = '<input type="text" id="editName-' + id + '" value="' + rowData.name + '">';
      formHtml += '<input type="number" id="editPrice-' + id + '" step="0.01" value="' + rowData.price + '">';
      formHtml += '<button onclick="saveUpdate(' + id + ')">Save</button>';
      formHtml += '<button onclick="cancelUpdate(' + id + ')">Cancel</button>';

      table.row(row).data(['', formHtml, '', '']).draw(false);
    });

    // Save update function
    function saveUpdate(id) {
      var newName = $('#editName-' + id).val();
      var newPrice = $('#editPrice-' + id).val();

      $.ajax({
        type: 'PUT',
        url: '/products/update',
        data: { id: id, name: newName, price: newPrice },
        success: function(response) {
          alert(response.message);
          table.ajax.reload();
        },
        error: function(error) {
          alert('An error occurred while updating the product.');
          console.error(error);
        }
      });
    }

    // Cancel update function
    function cancelUpdate(id) {
      table.ajax.reload();
    }
  </script>
</body>
</html>
